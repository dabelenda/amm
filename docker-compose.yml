version: '2'

services:

  redis:
     image: amm/redis
     build:
       context: docker/redis

  django:
    image: amm/django
    build: .
    volumes:
      - ./src:/opt/amm/src
      - ./htmlcov:/opt/amm/htmlcov
    environment:
      SECRET_KEY: ${SECRET_KEY}
      TEST_CORRECT_PWD: ${TEST_CORRECT_PWD}
      TEST_WRONG_PWD: ${TEST_WRONG_PWD}
      TEST_USERNAME: ${TEST_USERNAME}
      LDAP_USER_BASE_DN: ${LDAP_USER_BASE_DN}
      LDAP_SERVER: ${LDAP_SERVER}
      CACHE_REDIS_LOCATION: ${CACHE_REDIS_LOCATION}
      CACHE_REDIS_CLIENT_CLASS: ${CACHE_REDIS_CLIENT_CLASS}
    expose:
      - "8000"
    depends_on:
      - "redis"
    command: gunicorn --reload -w 2 -b :8000 --chdir /opt/amm/src/ --access-logfile - config.wsgi:application

  nginx:
    image: amm/nginx
    build:
       context: docker/nginx
    ports:
      - "127.0.0.1:8888:80"
    depends_on:
      - "django"
